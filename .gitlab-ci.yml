# Imagem base para todos os jobs
image: node:18

# DefiniÃ§Ã£o das fases do pipeline
stages:
  - test

# Cache compartilhado entre execuÃ§Ãµes
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
  policy: pull-push

# Job de testes unitÃ¡rios
unit_tests:
  stage: test
  # sobrescreve a imagem se quiser outra versÃ£o de Node apenas neste job
  image: node:18
  script:
    - echo "âœ”ï¸ Verificando versÃ£o do Node.js e npm..."
    - node -v
    - npm -v

    - echo "ğŸ§¹ Limpando cache do npm (precauÃ§Ã£o)..."
    - npm cache clean --force

    - echo "ğŸ“¦ Instalando dependÃªncias com npm ci..."
    - npm ci --legacy-peer-deps

    - echo "ğŸ§ª Rodando testes unitÃ¡rios (test:ci)..."
    - npm run test:ci

  # Gerar artefatos de cobertura sempre que rodar
  artifacts:
    when: always
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

  # Regras de execuÃ§Ã£o: somente em push para main
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      when: on_success
    - when: never
